<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wahrheit oder Pflicht</title>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:white; text-align:center; padding:20px;}
  button { padding:12px 20px; margin:10px; font-size:16px; cursor:pointer;}
  select, input { padding:8px; margin:5px;}
  .card { margin-top:20px; padding:20px; background:#222; border-radius:10px;}
  .hidden { display:none; }

  #targetsBox{
    margin-top:10px;
    font-size:14px;
    opacity:.92;
    padding:10px 12px;
    background:#1a1a1a;
    border:1px solid #333;
    border-radius:10px;
    display:none;
  }

  .guardBox{
    max-width:720px;
    margin:14px auto 0;
    text-align:left;
    padding:12px 14px;
    background:#1a1a1a;
    border:1px solid #333;
    border-radius:10px;
    font-size:14px;
  }
  .guardBox label{
    display:flex;
    gap:10px;
    align-items:flex-start;
    margin:8px 0;
    cursor:pointer;
  }
  .guardBox small{ color:#bbb; display:block; margin-left:26px; margin-top:2px; }
</style>
</head>
<body>

<h1>Wahrheit oder Pflicht</h1>

<div id="setup">
  <h3>Spieleranzahl</h3>
  <select id="playerCount" onchange="setPlayerCount()">
    <option value="2" selected>2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="8">8</option>
  </select>

  <h2>Spieler hinzufÃ¼gen</h2>
  <div id="players"></div>

  <h3>Level</h3>
  <select id="level">
    <option value="1">1 - Sanft</option>
    <option value="2">2 - Mittel</option>
    <option value="3">3 - Direkt</option>
    <option value="4">4 - Heavy</option>
    <option value="5">5 - Pervers & Dirty</option>
  </select>

  <div class="guardBox">
    <b>ðŸ”’ Ausschluss-Filter (Grundregeln)</b>
    <label>
      <input type="checkbox" id="guard_hetero_male_no_male" checked>
      <span>Hetero-Mann: keine direkte Interaktion mit MÃ¤nnern</span>
    </label>
    <small>Blockt Paarungen â€žaktiver Spieler = mÃ¤nnlich+heteroâ€œ â†” â€žZiel = mÃ¤nnlichâ€œ.</small>

    <label>
      <input type="checkbox" id="guard_homo_female_no_male" checked>
      <span>Homo-Frau: keine Interaktion mit MÃ¤nnern</span>
    </label>
    <small>Blockt Paarungen â€žaktiver Spieler = weiblich+homoâ€œ â†” â€žZiel = mÃ¤nnlichâ€œ.</small>

    <label>
      <input type="checkbox" id="guard_homo_male_no_female" checked>
      <span>Homo-Mann: keine Interaktion mit Frauen</span>
    </label>
    <small>Blockt Paarungen â€žaktiver Spieler = mÃ¤nnlich+homoâ€œ â†” â€žZiel = weiblichâ€œ.</small>
  </div>

  <br><br>
  <button onclick="startGame()">Spiel starten</button>
</div>

<div id="game" class="hidden">
  <h2 id="currentPlayer"></h2>

  <button onclick="draw('Wahrheit')">Wahrheit</button>
  <button onclick="draw('Pflicht')">Pflicht</button>

  <div id="result" class="card hidden">
    <p id="taskText"></p>
    <div id="targetsBox"></div>

    <div style="margin-top:12px;">
      <div style="margin-bottom:8px;">
        <button type="button" onclick="setTimerMinutes(1)">1 min</button>
        <button type="button" onclick="setTimerMinutes(3)">3 min</button>
        <button type="button" onclick="setTimerMinutes(5)">5 min</button>
      </div>

      <div style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;">
        <label style="font-size:14px;">
          Minuten:
          <input id="timerInputMinutes" type="number" min="0" step="1" value="0" style="width:90px;">
        </label>

        <button type="button" onclick="startTaskTimer()">Timer starten</button>
        <button type="button" onclick="stopTaskTimer()">Stop</button>
      </div>

      <div id="timer" style="margin-top:10px; font-size:18px;"></div>
    </div>
  </div>

  <button onclick="nextPlayer()">NÃ¤chster Spieler</button>
</div>

<script>
/* ---------------- State ---------------- */
let players = [];
let currentIndex = 0;
let tasks = [];

/* ---------------- Helpers ---------------- */
function norm(s){ return String(s ?? "").trim(); }
function normLower(s){ return norm(s).toLowerCase(); }

function parseList(csvField){
  const v = normLower(csvField);
  if(!v || v === "alle") return ["alle"];
  return v.split(",").map(x => x.trim()).filter(Boolean);
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function formatNames(names){
  if(!names || names.length===0) return "";
  if(names.length===1) return names[0];
  if(names.length===2) return `${names[0]} & ${names[1]}`;
  return `${names.slice(0,-1).join(", ")} & ${names[names.length-1]}`;
}

function hideTargets(){
  const box = document.getElementById("targetsBox");
  box.style.display = "none";
  box.innerHTML = "";
}

function showTargets(names){
  const box = document.getElementById("targetsBox");
  if(!names || names.length === 0){
    hideTargets();
    return;
  }
  box.style.display = "block";
  box.innerHTML = `<b>Beteiligte:</b> ${formatNames(names)}`;
}

/* ---------------- Guards (UI) ---------------- */
function guards(){
  return {
    heteroMaleNoMale: !!document.getElementById("guard_hetero_male_no_male")?.checked,
    homoFemaleNoMale: !!document.getElementById("guard_homo_female_no_male")?.checked,
    homoMaleNoFemale: !!document.getElementById("guard_homo_male_no_female")?.checked
  };
}

/* ---------------- Grund-Ausschlussfilter ---------------- */
function pairingAllowed(active, target){
  const g = guards();

  const aG = normLower(active.gender);
  const aO = normLower(active.orientation);
  const tG = normLower(target.gender);

  if(g.heteroMaleNoMale){
    if(aG === "mÃ¤nnlich" && aO === "hetero" && tG === "mÃ¤nnlich") return false;
  }

  if(g.homoFemaleNoMale){
    if(aG === "weiblich" && aO === "homo" && tG === "mÃ¤nnlich") return false;
  }

  if(g.homoMaleNoFemale){
    if(aG === "mÃ¤nnlich" && aO === "homo" && tG === "weiblich") return false;
  }

  return true;
}

/* ---------------- CSV Laden ---------------- */
async function loadTasks(){
  const response = await fetch('fragen.csv', { cache: "no-store" });
  const data = await response.text();

  const lines = data.split(/\r?\n/).filter(l => l.trim().length > 0);
  lines.shift(); // header weg

  tasks = lines.map(line => {
    const cols = line.split(";");

    return {
      type: norm(cols[0]),
      text: norm(cols[1]),
      level: Number(norm(cols[2])) || 0,
      wer: normLower(cols[3] || "alle"),
      allowed: parseList(cols[4] || "alle"),
      target: normLower(cols[5] || "alle"),
      timer: Number(norm(cols[6])) || 0,
      zieltyp: normLower(cols[7] || "selbst")
    };
  }).filter(t => t.type && t.text && t.level > 0);
}

/* ---------------- Spieler UI ---------------- */
function addPlayerRow(container){
  const div = document.createElement("div");
  div.innerHTML = `
    <input placeholder="Name">
    <select>
      <option>mÃ¤nnlich</option>
      <option>weiblich</option>
      <option>nonbinÃ¤r</option>
    </select>
    <select>
      <option>hetero</option>
      <option>homo</option>
      <option>bi</option>
      <option>pan</option>
      <option>offen</option>
    </select>
  `;
  container.appendChild(div);
}

function setPlayerCount(){
  const n = Number(document.getElementById("playerCount").value) || 2;
  const container = document.getElementById("players");
  container.innerHTML = "";
  for(let i=0;i<n;i++) addPlayerRow(container);
}

function startGame(){
  const rows = document.getElementById("players").children;
  players = [];

  for(const r of rows){
    const name = norm(r.children[0].value);
    const gender = norm(r.children[1].value);
    const orientation = norm(r.children[2].value);
    if(name) players.push({name, gender, orientation});
  }

  if(players.length < 2){
    alert("Mindestens 2 Spieler (mit Namen)!");
    return;
  }

  currentIndex = 0;
  document.getElementById("setup").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  document.getElementById("currentPlayer").innerText = players[currentIndex].name + " ist dran";

  document.getElementById("result").classList.add("hidden");
  hideTargets();
  stopTaskTimer();
}

function nextPlayer(){
  currentIndex = (currentIndex + 1) % players.length;
  document.getElementById("currentPlayer").innerText = players[currentIndex].name + " ist dran";
  document.getElementById("result").classList.add("hidden");
  hideTargets();
  stopTaskTimer();
}

/* ---------------- Target Auswahl ---------------- */
function eligibleTargetsForTask(task, activeIndex){
  const active = players[activeIndex];

  const others = players
    .map((p, idx) => ({...p, idx}))
    .filter(p => p.idx !== activeIndex);

  const byGender = others.filter(o => task.target === "alle" || normLower(o.gender) === task.target);

  const allowedByGuard = byGender.filter(o => pairingAllowed(active, o));

  return allowedByGuard;
}

function neededTargets(zieltyp){
  if(zieltyp === "einzel") return 1;
  if(zieltyp === "zwei") return 2;
  if(zieltyp === "gruppe") return 1;
  if(zieltyp === "beliebigviele") return 2;
  return 0; // selbst
}

function pickTargetsForTask(task, activeIndex){
  const zieltyp = task.zieltyp || "selbst";
  const eligible = shuffle(eligibleTargetsForTask(task, activeIndex));

  if(zieltyp === "selbst") return [];
  if(zieltyp === "einzel") return eligible.slice(0, 1).map(x => x.name);
  if(zieltyp === "zwei") return eligible.slice(0, 2).map(x => x.name);
  if(zieltyp === "gruppe") return eligible.map(x => x.name);

  if(zieltyp === "beliebigviele"){
    const n = eligible.length;
    if(n <= 2) return eligible.map(x => x.name);
    const count = 2 + Math.floor(Math.random() * (n - 1));
    return eligible.slice(0, count).map(x => x.name);
  }
  return [];
}

/* ---------------- Core: Draw ---------------- */
function activeAllowedByTask(task, active){
  // wer: aktive Person muss passen
  if(task.wer !== "alle" && task.wer !== normLower(active.gender)) return false;

  // allowed: "alle" oder Liste; "offen" behandeln wir als alle
  const aOri = normLower(active.orientation);
  if(aOri === "offen") return true;
  if(task.allowed.includes("alle")) return true;
  return task.allowed.includes(aOri);
}

function draw(type){
  const selectedLevel = Number(document.getElementById("level").value) || 1;
  const active = players[currentIndex];

  // STRIKT: Level exakt
  const pool = tasks.filter(t => {
    if(normLower(t.type) !== normLower(type)) return false;
    if(Number(t.level) !== selectedLevel) return false;
    if(!activeAllowedByTask(t, active)) return false;

    const need = neededTargets(t.zieltyp);
    const eligibleCount = eligibleTargetsForTask(t, currentIndex).length;

    if(need > 0 && eligibleCount < need) return false;
    if(t.zieltyp === "gruppe" && eligibleCount < 1) return false;

    return true;
  });

  if(pool.length === 0){
    alert("Keine passende Aufgabe gefunden (Level/Allowed/Wer/Targets/Filter).");
    return;
  }

  const chosen = pool[Math.floor(Math.random() * pool.length)];

  document.getElementById("taskText").innerText = chosen.text;
  document.getElementById("result").classList.remove("hidden");

  const targets = pickTargetsForTask(chosen, currentIndex);
  showTargets(targets);

  stopTaskTimer();
  document.getElementById("timer").innerText = "";
  document.getElementById("timerInputMinutes").value = "0";
}

/* ---------------- Timer ---------------- */
let taskTimerInterval = null;
let taskTimerRemaining = 0;

function setTimerMinutes(min) {
  document.getElementById("timerInputMinutes").value = String(min);
}

function startTaskTimer() {
  stopTaskTimer();

  const mins = parseInt(document.getElementById("timerInputMinutes").value || "0", 10);
  if (!mins || mins <= 0) {
    document.getElementById("timer").innerText = "";
    alert("Bitte Minuten > 0 einstellen.");
    return;
  }

  taskTimerRemaining = mins * 60;
  renderTaskTimer();

  taskTimerInterval = setInterval(() => {
    taskTimerRemaining--;
    renderTaskTimer();

    if (taskTimerRemaining <= 0) {
      stopTaskTimer();
      document.getElementById("timer").innerText = "Zeit!";
    }
  }, 1000);
}

function stopTaskTimer() {
  if (taskTimerInterval) {
    clearInterval(taskTimerInterval);
    taskTimerInterval = null;
  }
}

function renderTaskTimer() {
  const m = Math.floor(taskTimerRemaining / 60);
  const s = taskTimerRemaining % 60;
  document.getElementById("timer").innerText =
    "Timer: " + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

/* ---------------- Init ---------------- */
setPlayerCount();
loadTasks();
</script>

</body>
</html>
