<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wahrheit oder Pflicht</title>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:white; text-align:center; padding:20px;}
  button { padding:12px 20px; margin:10px; font-size:16px; cursor:pointer;}
  select, input { padding:8px; margin:5px;}
  .card { margin-top:20px; padding:20px; background:#222; border-radius:10px;}
  .hidden { display:none; }

  #targetsBox{
    margin-top:10px;
    font-size:14px;
    opacity:.92;
    padding:10px 12px;
    background:#1a1a1a;
    border:1px solid #333;
    border-radius:10px;
    display:none;
  }
</style>
</head>
<body>

<h1>Wahrheit oder Pflicht</h1>

<div id="setup">
  <h3>Spieleranzahl</h3>
  <select id="playerCount">
    <option value="2" selected>2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="8">8</option>
  </select>

  <h2>Spieler hinzufügen</h2>
  <div id="players"></div>

  <h3>Level</h3>
  <select id="level">
    <option value="1">1 - Sanft</option>
    <option value="2">2 - Mittel</option>
    <option value="3">3 - Direkt</option>
    <option value="4">4 - Heavy</option>
    <option value="5">5 - Pervers & Dirty</option>
  </select>

  <br><br>
  <button id="btnStart">Spiel starten</button>
</div>

<div id="game" class="hidden">
  <h2 id="currentPlayer"></h2>

  <button id="btnTruth">Wahrheit</button>
  <button id="btnDare">Pflicht</button>

  <div id="result" class="card hidden">
    <p id="taskText"></p>
    <div id="targetsBox"></div>

    <div style="margin-top:12px;">
      <div style="margin-bottom:8px;">
        <button type="button" id="t1">1 min</button>
        <button type="button" id="t3">3 min</button>
        <button type="button" id="t5">5 min</button>
      </div>

      <div style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;">
        <label style="font-size:14px;">
          Minuten:
          <input id="timerInputMinutes" type="number" min="0" step="1" value="0" style="width:90px;">
        </label>

        <button type="button" id="btnTimerStart">Timer starten</button>
        <button type="button" id="btnTimerStop">Stop</button>
      </div>

      <div id="timer" style="margin-top:10px; font-size:18px;"></div>
    </div>
  </div>

  <button id="btnNext">Nächster Spieler</button>
</div>

<script>
/* =========================
   State
========================= */
let players = [];
let currentIndex = 0;
let tasks = [];

/* =========================
   Helpers
========================= */
const $ = (id) => document.getElementById(id);

function normalize(s){
  return String(s ?? "").trim().toLowerCase();
}

function parseAllowedList(s){
  const v = normalize(s);
  if(!v || v === "alle") return ["alle"];
  return v.split(",").map(x=>x.trim()).filter(Boolean);
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function formatNames(names){
  if(!names || names.length===0) return "";
  if(names.length===1) return names[0];
  if(names.length===2) return `${names[0]} & ${names[1]}`;
  return `${names.slice(0,-1).join(", ")} & ${names[names.length-1]}`;
}

function hideTargets(){
  const box = $("targetsBox");
  box.style.display = "none";
  box.innerHTML = "";
}

function showTargets(names){
  const box = $("targetsBox");
  if(!names || names.length === 0){
    hideTargets();
    return;
  }
  box.style.display = "block";
  box.innerHTML = `<b>Beteiligte:</b> ${formatNames(names)}`;
}

/* =========================
   CSV Laden
   Erwarteter Header:
   type;text;level;wer;allowed;target;timer;zieltyp
========================= */
async function loadTasks(){
  const response = await fetch("fragen.csv", { cache: "no-store" });
  if(!response.ok) throw new Error("fragen.csv nicht gefunden (muss neben index.html liegen).");

  const data = await response.text();
  const lines = data.split(/\r?\n/).filter(l => l.trim().length > 0);
  if(lines.length < 2) { tasks = []; return; }

  const header = lines.shift();
  const sep = header.includes(";") ? ";" : ",";
  const h = header.split(sep).map(x => normalize(x));

  const idx = {
    type: h.indexOf("type"),
    text: h.indexOf("text"),
    level: h.indexOf("level"),
    wer: h.indexOf("wer"),
    allowed: h.indexOf("allowed"),
    target: h.indexOf("target"),
    timer: h.indexOf("timer"),
    zieltyp: h.indexOf("zieltyp"),
  };

  // Minimal: type/text/level müssen existieren
  if(idx.type < 0 || idx.text < 0 || idx.level < 0){
    throw new Error("CSV-Header muss mindestens enthalten: type, text, level (zusätzlich: wer, allowed, target, timer, zieltyp).");
  }

  tasks = lines.map(line => {
    const cols = line.split(sep).map(c => String(c ?? "").trim());
    const t = {
      type: cols[idx.type] || "",
      text: cols[idx.text] || "",
      level: Number(cols[idx.level] || 0) || 0,

      // neu/optional:
      wer: (idx.wer >= 0 ? cols[idx.wer] : "alle") || "alle",
      allowed: (idx.allowed >= 0 ? cols[idx.allowed] : "alle") || "alle",
      target: (idx.target >= 0 ? cols[idx.target] : "alle") || "alle",
      timer: Number((idx.timer >= 0 ? cols[idx.timer] : 0) || 0) || 0,
      zieltyp: (idx.zieltyp >= 0 ? cols[idx.zieltyp] : "Selbst") || "Selbst",
    };
    return t;
  }).filter(t => t.type && t.text && t.level > 0);
}

/* =========================
   Spieler UI
========================= */
function addPlayerRow(){
  const container = $("players");
  const div = document.createElement("div");
  div.innerHTML = `
    <input placeholder="Name">
    <select>
      <option>männlich</option>
      <option>weiblich</option>
      <option>nonbinär</option>
    </select>
    <select>
      <option>hetero</option>
      <option>homo</option>
      <option>bi</option>
      <option>pan</option>
      <option>offen</option>
    </select>
  `;
  container.appendChild(div);
}

function setPlayerCount(){
  const n = parseInt($("playerCount").value, 10);
  const container = $("players");
  container.innerHTML = "";
  for(let i=0;i<n;i++) addPlayerRow();
}

function startGame(){
  const rows = $("players").children;
  players = [];

  for(const row of rows){
    const name = row.children[0].value.trim();
    const gender = row.children[1].value;         // "männlich/weiblich/nonbinär"
    const orientation = row.children[2].value;    // "hetero/homo/bi/pan/offen"
    if(name) players.push({name, gender, orientation});
  }

  if(players.length < 2){
    alert("Mindestens 2 Spieler (mit Namen)!");
    return;
  }

  currentIndex = 0;
  $("setup").classList.add("hidden");
  $("game").classList.remove("hidden");
  $("currentPlayer").innerText = players[currentIndex].name + " ist dran";
}

/* =========================
   Targets / Mehrspieler
========================= */
function eligibleTargetsForTask(task, activeIndex){
  const active = players[activeIndex];
  const others = players
    .map((p, idx) => ({...p, idx}))
    .filter(p => p.idx !== activeIndex);

  const targetRule = normalize(task.target);
  if(targetRule === "alle") return others;

  // target ist ein Gender: männlich/weiblich/nonbinär
  return others.filter(o => normalize(o.gender) === targetRule);
}

function pickTargetsForTask(task, activeIndex){
  const zieltyp = (task.zieltyp || "Selbst").trim(); // Selbst/Einzel/Zwei/Gruppe/BeliebigViele
  const eligible = shuffle(eligibleTargetsForTask(task, activeIndex));
  const names = eligible.map(e => e.name);

  if(zieltyp === "Selbst") return [];
  if(zieltyp === "Einzel") return names.slice(0, 1);
  if(zieltyp === "Zwei")   return names.slice(0, 2);
  if(zieltyp === "Gruppe") return names;
  if(zieltyp === "BeliebigViele"){
    if(names.length <= 2) return names;
    const count = 2 + Math.floor(Math.random() * (names.length - 1)); // 2..n
    return names.slice(0, count);
  }
  return [];
}

/* =========================
   Task Matching
========================= */
function taskMatches(task, type, selectedLevel, active, activeIndex){
  if(task.type !== type) return false;

  // Level: nur <= selected
  if(task.level <= 0 || task.level > selectedLevel) return false;

  // wer: muss zum aktiven Gender passen oder "alle"
  const werRule = normalize(task.wer || "alle");
  const activeGender = normalize(active.gender);
  if(!(werRule === "alle" || werRule === activeGender)) return false;

  // allowed: muss aktive Orientierung enthalten oder "alle"
  const allowedList = parseAllowedList(task.allowed);
  const activeOri = normalize(active.orientation);
  if(!(allowedList.includes("alle") || allowedList.includes(activeOri))) return false;

  // Wenn zieltyp Targets verlangt, müssen genug passende Targets existieren
  const zieltyp = (task.zieltyp || "Selbst").trim();
  const eligibleCount = eligibleTargetsForTask(task, activeIndex).length;

  const need =
    zieltyp === "Zwei" ? 2 :
    zieltyp === "Einzel" ? 1 :
    zieltyp === "Gruppe" ? 1 :
    zieltyp === "BeliebigViele" ? 2 :
    0;

  if(need > 0 && eligibleCount < need) return false;

  return true;
}

function applyPlaceholders(text, activeName, targetNames){
  let out = String(text);

  // Optional: Platzhalter
  out = out.replaceAll("{active}", activeName);
  if(targetNames && targetNames.length){
    out = out.replaceAll("{targets}", formatNames(targetNames));
    out = out.replaceAll("{t1}", targetNames[0] || "");
    out = out.replaceAll("{t2}", targetNames[1] || "");
    out = out.replaceAll("{t3}", targetNames[2] || "");
  }else{
    out = out.replaceAll("{targets}", "");
    out = out.replaceAll("{t1}", "");
    out = out.replaceAll("{t2}", "");
    out = out.replaceAll("{t3}", "");
  }
  return out;
}

/* =========================
   Draw
========================= */
function draw(type){
  const selectedLevel = Number($("level").value) || 1;
  const active = players[currentIndex];

  const valid = tasks.filter(t => taskMatches(t, type, selectedLevel, active, currentIndex));

  if(valid.length === 0){
    alert("Keine passende Aufgabe gefunden (prüfe: Level / wer / allowed / target / zieltyp).");
    return;
  }

  const task = valid[Math.floor(Math.random() * valid.length)];

  const targetNames = pickTargetsForTask(task, currentIndex);
  showTargets(targetNames);

  const finalText = applyPlaceholders(task.text, active.name, targetNames);
  $("taskText").innerText = finalText;

  $("result").classList.remove("hidden");

  // Timer reset
  stopTaskTimer();
  $("timer").innerText = "";
  $("timerInputMinutes").value = "0";
}

function nextPlayer(){
  currentIndex = (currentIndex + 1) % players.length;
  $("currentPlayer").innerText = players[currentIndex].name + " ist dran";
  $("result").classList.add("hidden");
  hideTargets();
  stopTaskTimer();
}

/* =========================
   Timer
========================= */
let taskTimerInterval = null;
let taskTimerRemaining = 0;

function setTimerMinutes(min) {
  $("timerInputMinutes").value = String(min);
}

function startTaskTimer() {
  stopTaskTimer();

  const mins = parseInt($("timerInputMinutes").value || "0", 10);
  if (!mins || mins <= 0) {
    $("timer").innerText = "";
    alert("Bitte Minuten > 0 einstellen.");
    return;
  }

  taskTimerRemaining = mins * 60;
  renderTaskTimer();

  taskTimerInterval = setInterval(() => {
    taskTimerRemaining--;
    renderTaskTimer();

    if (taskTimerRemaining <= 0) {
      stopTaskTimer();
      $("timer").innerText = "Zeit!";
    }
  }, 1000);
}

function stopTaskTimer() {
  if (taskTimerInterval) {
    clearInterval(taskTimerInterval);
    taskTimerInterval = null;
  }
}

function renderTaskTimer() {
  const m = Math.floor(taskTimerRemaining / 60);
  const s = taskTimerRemaining % 60;
  $("timer").innerText =
    "Timer: " + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}

/* =========================
   Wire up / Init
========================= */
$("playerCount").addEventListener("change", setPlayerCount);
$("btnStart").addEventListener("click", startGame);
$("btnTruth").addEventListener("click", () => draw("Wahrheit"));
$("btnDare").addEventListener("click", () => draw("Pflicht"));
$("btnNext").addEventListener("click", nextPlayer);

$("t1").addEventListener("click", () => setTimerMinutes(1));
$("t3").addEventListener("click", () => setTimerMinutes(3));
$("t5").addEventListener("click", () => setTimerMinutes(5));
$("btnTimerStart").addEventListener("click", startTaskTimer);
$("btnTimerStop").addEventListener("click", stopTaskTimer);

(async () => {
  try{
    await loadTasks();
  }catch(e){
    alert("Fehler beim Laden der CSV: " + (e.message || e));
  }
  setPlayerCount(); // erzeugt Spielerfelder
})();
</script>

</body>
</html>
