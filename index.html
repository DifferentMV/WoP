<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wahrheit oder Pflicht</title>
<style>
body { font-family: Arial, sans-serif; background:#111; color:white; text-align:center; padding:20px;}
button { padding:12px 20px; margin:10px; font-size:16px; cursor:pointer;}
select, input { padding:8px; margin:5px;}
.card { margin-top:20px; padding:20px; background:#222; border-radius:10px;}
.hidden { display:none; }
</style>
</head>
<body>

<h1>Wahrheit oder Pflicht</h1>

<div id="setup">
<h2>Spieler hinzufügen</h2>
<div id="players"></div>
<button onclick="addPlayer()">+ Spieler</button>

<h3>Level</h3>
<select id="level">
  <option value="1">1 - Sanft</option>
  <option value="2">2 - Mittel</option>
  <option value="3">3 - Direkt</option>
  <option value="4">4 - Heavy</option>
  <option value="5">5 - Pervers & Dirty</option>
</select>
<br><br>


<br><br>
<button onclick="startGame()">Spiel starten</button>
</div>

<div id="game" class="hidden">
<h2 id="currentPlayer"></h2>

<button onclick="draw('Wahrheit')">Wahrheit</button>
<button onclick="draw('Pflicht')">Pflicht</button>

<div id="result" class="card hidden">
  <p id="taskText"></p>

  <div style="margin-top:12px;">
    <div style="margin-bottom:8px;">
      <button type="button" onclick="setTimerMinutes(1)">1 min</button>
      <button type="button" onclick="setTimerMinutes(3)">3 min</button>
      <button type="button" onclick="setTimerMinutes(5)">5 min</button>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;">
      <label style="font-size:14px;">
        Minuten:
        <input id="timerInputMinutes" type="number" min="0" step="1" value="0" style="width:90px;">
      </label>

      <button type="button" onclick="startTaskTimer()">Timer starten</button>
      <button type="button" onclick="stopTaskTimer()">Stop</button>
    </div>

    <div id="timer" style="margin-top:10px; font-size:18px;"></div>
  </div>
</div>

<button onclick="nextPlayer()">Nächster Spieler</button>
</div>

<script>

let players = [];
let currentIndex = 0;
let tasks = [];

async function loadTasks(){
    const response = await fetch('fragen.csv');
    const data = await response.text();
    const rows = data.split("\n").slice(1);
    tasks = rows.map(r => {
        const cols = r.split(",");
        return {
            type: cols[0],
            text: cols[1],
            level: parseInt(cols[2]),
            allowed: cols[3],
            target: cols[4],
            timer: parseInt(cols[5])
        };
    });
}

function addPlayer(){
    const container = document.getElementById("players");
    const div = document.createElement("div");
    div.innerHTML = `
        <input placeholder="Name">
        <select>
            <option>männlich</option>
            <option>weiblich</option>
            <option>nonbinär</option>
        </select>
        <select>
            <option>hetero</option>
            <option>homo</option>
            <option>bi</option>
            <option>pan</option>
        </select>
    `;
    container.appendChild(div);
}

function startGame(){
    const container = document.getElementById("players").children;
    players = [];
    for(let p of container){
        const name = p.children[0].value;
        const gender = p.children[1].value;
        const orientation = p.children[2].value;
        if(name){
            players.push({name, gender, orientation});
        }
    }
    if(players.length < 2){
        alert("Mindestens 2 Spieler!");
        return;
    }
    currentIndex = 0;
    document.getElementById("setup").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    document.getElementById("currentPlayer").innerText = players[currentIndex].name + " ist dran";
}

function nextPlayer(){
    currentIndex = (currentIndex + 1) % players.length;
    document.getElementById("currentPlayer").innerText = players[currentIndex].name + " ist dran";
    document.getElementById("result").classList.add("hidden");
}

function draw(type){
    const level = parseInt(document.getElementById("level").value);
    const active = players[currentIndex];
    const others = players.filter((_,i)=>i!==currentIndex);

    const validTasks = tasks.filter(t =>
        t.type === type &&
        t.level <= level &&
        (t.allowed === "alle" || t.allowed.includes(active.orientation)) &&
        others.some(o => t.target === "alle" || t.target === o.gender)
    );

    if(validTasks.length === 0){
        alert("Keine passende Aufgabe gefunden");
        return;
    }

    const task = validTasks[Math.floor(Math.random()*validTasks.length)];

    document.getElementById("taskText").innerText = task.text;
    document.getElementById("result").classList.remove("hidden");
stopTaskTimer();
document.getElementById("timer").innerText = "";
document.getElementById("timerInputMinutes").value = "0";
   const timerEnabled = document.getElementById("timerEnabled").checked;
const timerMode = document.getElementById("timerMode").value;

let chosenTimer = 0;

if (timerEnabled) {
  if (timerMode === "csv") {
    chosenTimer = isNaN(task.timer) ? 0 : task.timer;
  } else if (timerMode === "rand_1_3") {
    // 1 bis 3 Minuten zufällig
    const options = [60, 120, 180];
    chosenTimer = options[Math.floor(Math.random() * options.length)];
  } else if (timerMode === "off") {
    chosenTimer = 0;
  } else {
    // feste Sekunden aus Dropdown (60 oder 180)
    chosenTimer = parseInt(timerMode, 10) || 0;
  }
}

const timerDiv = document.getElementById("timer");

}
let taskTimerInterval = null;
let taskTimerRemaining = 0;

function setTimerMinutes(min) {
  document.getElementById("timerInputMinutes").value = String(min);
}

function startTaskTimer() {
  stopTaskTimer();

  const mins = parseInt(document.getElementById("timerInputMinutes").value || "0", 10);
  if (!mins || mins <= 0) {
    document.getElementById("timer").innerText = "";
    alert("Bitte Minuten > 0 einstellen.");
    return;
  }

  taskTimerRemaining = mins * 60;
  renderTaskTimer();

  taskTimerInterval = setInterval(() => {
    taskTimerRemaining--;
    renderTaskTimer();

    if (taskTimerRemaining <= 0) {
      stopTaskTimer();
      document.getElementById("timer").innerText = "Zeit!";
    }
  }, 1000);
}

function stopTaskTimer() {
  if (taskTimerInterval) {
    clearInterval(taskTimerInterval);
    taskTimerInterval = null;
  }
}

function renderTaskTimer() {
  const m = Math.floor(taskTimerRemaining / 60);
  const s = taskTimerRemaining % 60;
  document.getElementById("timer").innerText =
    "Timer: " + String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}
loadTasks();
addPlayer();
addPlayer();

</script>
  
</body>
</html>
